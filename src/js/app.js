import { Api } from './lib.js';

const baseURL = 'https://foxslot-vs-posts.herokuapp.com';
const api = new Api(baseURL);

const rootEl = document.getElementById('root');

let posts = [];

let lastSeenID = 0;
let newPostsId = 0;
const numberPosts = 5;

const addFormEl = document.createElement('form');
rootEl.appendChild(addFormEl);

const groupForm = addElement('div', 'form-row', addFormEl);
const groupInput = addElement('div', 'form-group col-md-7', groupForm);
const groupSelectButton = addElement('div', 'form-group col-md-3', groupForm);
const groupButton = addElement('div', 'form-group col-md-2', groupForm);

const inputEl = addElement('input', 'form-control my-2 mr-sm-2', groupInput);
inputEl.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É';
inputEl.setAttribute('data-id', 'link');

const selectEl = addElement('select', 'custom-select my-2 mr-sm-2', groupSelectButton);
selectEl.setAttribute('data-id', 'type');

//–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞
const options = ['regular', 'image', 'audio', 'video'];
addOptions(selectEl, options);

const addEl = addElement('button', 'btn btn-primary my-2 mr-sm-2', groupButton);
addEl.textContent = '–î–æ–±–∞–≤–∏—Ç—å';

const linkEl = addFormEl.querySelector('[data-id=link]');
const typeEl = addFormEl.querySelector('[data-id=type]');

addFormEl.onsubmit = function (ev) {
    ev.preventDefault();

    const data = {
        typeContent: typeEl.value,
        linkContent: linkEl.value,
        id: 0,
        content: linkEl.value,
    };

    api.postJSON('/posts', data, addNewPost, sendError);

    linkEl.value = '';
    typeEl.value = 'regular';

};

const buttonLoadNewPosts = addElement('button', 'btn btn-primary d-block mx-auto mt-2', rootEl);
buttonLoadNewPosts.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã';
buttonLoadNewPosts.setAttribute('data-id', 'load-new-posts-button');
buttonLoadNewPosts.addEventListener('click', loadNewPosts);
buttonLoadNewPosts.classList.toggle('button-invisibility');


const postsEl = addElement('ul', 'list-group', rootEl);

const addPostsEl = addElement('button', 'btn btn-primary d-block mx-auto mt-2', rootEl);
addPostsEl.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ';
addPostsEl.setAttribute('data-id', 'load-more-button');
addPostsEl.addEventListener('click', loadPosts)

function loadPosts() {

    fetch(`${baseURL}/posts/${lastSeenID}/${numberPosts}`).then(
        res => {
            if (!res.ok) {
                throw new Error(res.statusText);
            }
            return res.json();
        }
    ).then(
        data => {
            if (data.length >= numberPosts) {
                addPosts(data);
            } else if (data.length === 0) {
                const buttonLoadEl = rootEl.querySelector('[data-id=load-more-button]');
                rootEl.removeChild(buttonLoadEl);
            } else {
                addPosts(data);
                const buttonLoadEl = rootEl.querySelector('[data-id=load-more-button]');
                rootEl.removeChild(buttonLoadEl);
            };
        }
    ).catch(error => {
        console.log(error);
    });

};

function addPosts(items) {

    for (const item of items) {

        if (!findIndexById(item.id) === -1) {
            updatePostFromID(item.id);
        } else {

            //—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            const postEl = addElement('div', 'card my-2 mr-sm-2', postsEl);
            postEl.setAttribute('data-post-id', `${item.id}`);
            let captionPost = '';

            if (item.typeContent === 'regular') {

                //c–æ–∑–¥–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
                const textEl = addElement('h5', 'card-text ml-3', postEl);
                textEl.textContent = item.linkContent;

                captionPost = '–ü–æ—Å—Ç —Å —Ç–µ–∫—Å—Ç–æ–º';

            } else if (item.typeContent === 'image') {

                //—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                const imgEl = addElement('img', 'card-img-top', postEl);
                imgEl.src = item.linkContent;

                captionPost = '–ü–æ—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º';

            } else if (item.typeContent === 'audio') {

                //—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –∞—É–¥–∏–æ
                const audioScr = addElement('audio', 'card-img-top', postEl);
                audioScr.src = item.linkContent;
                audioScr.controls = true;

                captionPost = '–ü–æ—Å—Ç —Å –∞—É–¥–∏–æ';

            } else if (item.typeContent === 'video') {

                //—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –≤–∏–¥–µ–æ
                const videoScr = addElement('video', 'embed-responsive-item', postEl);
                videoScr.src = item.linkContent;
                videoScr.controls = true;

                captionPost = '–ü–æ—Å—Ç —Å –≤–∏–¥–µ–æ';

            } else {

                // –ø–æ—Å—Ç —Å–æ —Å–ø–∞–º–æ–º
                const textEl = addElement('p', 'card-text', postEl);
                textEl.textContent = '–°–ø–∞–º';

                captionPost = '–ü–æ—Å—Ç —Å–æ —Å–ø–∞–º–æ–º';

            };

            //–æ–±–ª–∞—Å—Ç—å –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
            const postBodyEl = addElement('div', 'card-body', postEl);

            //–ø–æ–¥–ø–∏—Å—å –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
            const postContentEl = addElement('p', 'card-text', postBodyEl);
            postContentEl.textContent = captionPost;

            //–ª–∞–π–∫–∏
            const likesEl = addElement('button', 'btn btn-primary', postBodyEl);
            likesEl.textContent = '‚ù§ ' + item.likes;
            likesEl.setAttribute('data-id', 'button-like');
            likesEl.onclick = function () {
                api.postJSON(`/posts/${item.id}/likes`, null, updatePost, sendError);
            };

            //–¥–∏–∑–ª–∞–π–∫–∏ –∫–∞–∫ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ª–∞–π–∫–æ–≤
            const dislikesEl = addElement('button', 'btn btn-primary ml-2', postBodyEl);
            dislikesEl.textContent = 'üëé';
            dislikesEl.onclick = function () {
                api.deleteJSON(`/posts/${item.id}/likes`, null, updatePost, sendError);
            };

            posts.unshift(item);

        };

    };

    posts.sort((a, b) => { return b.id - a.id });
    lastSeenID = posts[posts.length - 1].id;
    newPostsId = posts[0].id + 1;

};

function rebuildLists() {

    posts.sort((a, b) => { return b.id - a.id });

    postsEl.innerHTML = '';

    for (const item of posts) {

        //—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        const postEl = addElement('div', 'card my-2 mr-sm-2', postsEl);
        postEl.setAttribute('data-post-id', `${item.id}`);
        let captionPost = '';

        if (item.typeContent === 'regular') {

            //c–æ–∑–¥–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
            const textEl = addElement('h5', 'card-text ml-3', postEl);
            textEl.textContent = item.linkContent;

            captionPost = '–ü–æ—Å—Ç —Å —Ç–µ–∫—Å—Ç–æ–º';

        } else if (item.typeContent === 'image') {

            //—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            const imgEl = addElement('img', 'card-img-top', postEl);
            imgEl.src = item.linkContent;

            captionPost = '–ü–æ—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º';

        } else if (item.typeContent === 'audio') {

            //—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –∞—É–¥–∏–æ
            const audioScr = addElement('audio', 'card-img-top', postEl);
            audioScr.src = item.linkContent;
            audioScr.controls = true;

            captionPost = '–ü–æ—Å—Ç —Å –∞—É–¥–∏–æ';

        } else if (item.typeContent === 'video') {

            //—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –≤–∏–¥–µ–æ
            const videoScr = addElement('video', 'embed-responsive-item', postEl);
            videoScr.src = item.linkContent;
            videoScr.controls = true;

            captionPost = '–ü–æ—Å—Ç —Å –≤–∏–¥–µ–æ';

        } else {

            // –ø–æ—Å—Ç —Å–æ —Å–ø–∞–º–æ–º
            const textEl = addElement('p', 'card-text', postEl);
            textEl.textContent = '–°–ø–∞–º';

            captionPost = '–ü–æ—Å—Ç —Å–æ —Å–ø–∞–º–æ–º';

        };

        //–æ–±–ª–∞—Å—Ç—å –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
        const postBodyEl = addElement('div', 'card-body', postEl);

        //–ø–æ–¥–ø–∏—Å—å –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
        const postContentEl = addElement('p', 'card-text', postBodyEl);
        postContentEl.textContent = captionPost;

        //–ª–∞–π–∫–∏
        const likesEl = addElement('button', 'btn btn-primary', postBodyEl);
        likesEl.textContent = '‚ù§ ' + item.likes;
        likesEl.setAttribute('data-id', 'button-like');
        likesEl.onclick = function () {
            api.postJSON(`/posts/${item.id}/likes`, null, updatePost, sendError);
        };

        //–¥–∏–∑–ª–∞–π–∫–∏ –∫–∞–∫ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ª–∞–π–∫–æ–≤
        const dislikesEl = addElement('button', 'btn btn-primary ml-2', postBodyEl);
        dislikesEl.textContent = 'üëé';
        dislikesEl.onclick = function () {
            api.deleteJSON(`/posts/${item.id}/likes`, null, updatePost, sendError);
        };

    };

};

//—Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏ —Ç–µ–≥–∞, 
function addElement(tagNameEl, classNameEl, parrentElementEl) {

    const itemEl = document.createElement(tagNameEl);
    itemEl.className = classNameEl;
    parrentElementEl.appendChild(itemEl);

    return itemEl;

};

//—Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ —á–µ—Ä–µ–∑ –º–∞—Å—Å–∏–≤ —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
function addOptions(selectEl, namesOptions) {

    for (const optionItem of namesOptions) {
        const optEl = document.createElement('option');
        optEl.value = optionItem;
        if (optEl.value === 'regular') {
            optEl.textContent = '–û–±—ã—á–Ω—ã–π';
        } else if (optEl.value === 'image') {
            optEl.textContent = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
        } else if (optEl.value === 'audio') {
            optEl.textContent = '–ê—É–¥–∏–æ';
        } else if (optEl.value === 'video') {
            optEl.textContent = '–í–∏–¥–µ–æ';
        } else {
            optEl.textContent = optionItem;
        };
        selectEl.appendChild(optEl);
    };
};

function updatePost(data) {

    const post = posts[findIndexById(data.id)];
    post.likes = data.likes;

    const updPostEl = postsEl.querySelector(`[data-post-id="${post.id}"]`);
    const buttonLike = updPostEl.querySelector(`[data-id='button-like']`);
    buttonLike.textContent = '‚ù§ ' + post.likes;

};

function updatePostFromID(id) {

    fetch(`${baseURL}/post/${id}`).then(
        res => {
            if (!res.ok) {
                throw new Error(res.statusText);
            }
            return res.json();
        }
    ).then(
        data => {
            const post = posts[findIndexById(data.id)];
            post.likes = data.likes;

            const postEl = postsEl.querySelector(`[data-post-id = ${post.id}]`);
            const buttonLike = postEl.querySelector(`[data-id = button-like]`);
            buttonLike.textContent = '‚ù§ ' + post.likes;
        }
    ).catch(error => {
        console.log(error);
    });

};

function findIndexById(id) {
    return posts.findIndex(o => o.id === id);
};

function addNewPost(item) {
    posts.unshift(item);
    newPostsId = posts[0].id + 1;
    rebuildLists();    
}

function addNewPostEl(item) {

    //—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    const postEl = addElement('div', 'card my-2 mr-sm-2', postsEl);

    let captionPost = '';

    if (item.typeContent === 'regular') {

        //c–æ–∑–¥–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
        const textEl = addElement('h5', 'card-text ml-3', postEl);
        textEl.textContent = item.linkContent;

        captionPost = '–ü–æ—Å—Ç —Å —Ç–µ–∫—Å—Ç–æ–º';

    } else if (item.typeContent === 'image') {

        //—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        const imgEl = addElement('img', 'card-img-top', postEl);
        imgEl.src = item.linkContent;

        captionPost = '–ü–æ—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º';

    } else if (item.typeContent === 'audio') {

        //—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –∞—É–¥–∏–æ
        const audioScr = addElement('audio', 'card-img-top', postEl);
        audioScr.src = item.linkContent;
        audioScr.controls = true;

        captionPost = '–ü–æ—Å—Ç —Å –∞—É–¥–∏–æ';

    } else if (item.typeContent === 'video') {

        //—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –≤–∏–¥–µ–æ
        const videoScr = addElement('video', 'embed-responsive-item', postEl);
        videoScr.src = item.linkContent;
        videoScr.controls = true;

        captionPost = '–ü–æ—Å—Ç —Å –≤–∏–¥–µ–æ';

    } else {

        // –ø–æ—Å—Ç —Å–æ —Å–ø–∞–º–æ–º
        const textEl = addElement('p', 'card-text', postEl);
        textEl.textContent = '–°–ø–∞–º';

        captionPost = '–ü–æ—Å—Ç —Å–æ —Å–ø–∞–º–æ–º';

    };

    //–æ–±–ª–∞—Å—Ç—å –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
    const postBodyEl = addElement('div', 'card-body', postEl);

    //–ø–æ–¥–ø–∏—Å—å –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
    const postContentEl = addElement('p', 'card-text', postBodyEl);
    postContentEl.textContent = captionPost;

    //–ª–∞–π–∫–∏
    const likesEl = addElement('button', 'btn btn-primary', postBodyEl);
    likesEl.textContent = '‚ù§ ' + item.likes;
    likesEl.setAttribute('data-id', 'button-like');
    likesEl.onclick = function () {
        api.postJSON(`/posts/${item.id}/likes`, null, updatePost, sendError);
    };

    //–¥–∏–∑–ª–∞–π–∫–∏ –∫–∞–∫ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ª–∞–π–∫–æ–≤
    const dislikesEl = addElement('button', 'btn btn-primary ml-2', postBodyEl);
    dislikesEl.textContent = 'üëé';
    dislikesEl.onclick = function () {
        api.deleteJSON(`/posts/${item.id}/likes`, null, updatePost, sendError);
    };

};

const sendError = error => {
    console.log(error);
};

function loadNewPosts() {

    fetch(`${baseURL}/get-new-posts/${newPostsId}`)
        .then(
            res => {
                if (!res.ok) {
                    throw new Error(res.statusText);
                }
                return res.json();
            }

        ).then(
            data => {
                if (data === 'false') {
                    return;
                }

                addPosts(data);
                buttonLoadNewPosts.classList.toggle('button-invisibility');
                rebuildLists();
            }
        ).catch(error => {
            console.log(error);
        });
};

setInterval(() => {
    fetch(`${baseURL}/new-posts/${newPostsId}`)
        .then(
            res => {
                if (!res.ok) {
                    throw new Error(res.statusText);
                }
                return res.text();
            }
        ).then(
            data => {

                if (data === 'false') {
                    return;
                }

                buttonLoadNewPosts.classList.remove('button-invisibility');
                buttonLoadNewPosts.textContent = `–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã (${data})`;

            }
        ).catch(error => {
            console.log(error);
        });
}, 5000);

loadPosts();

